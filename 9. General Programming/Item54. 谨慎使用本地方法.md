# Item54. 谨慎使用本地方法



JNI：Java Native Interface 允许程序调用「本地方法」，所谓本地方法是指用「本地程序语言比如 C、C++」来编写的特殊方法。本地方法在本地语言中可以执行任意的计算任务，并返回到 Java 语言。



从历史上看，本地方法有 3 种用途：

1. 它们提供了「访问特定于平台的机制」的能力：比如注册表（registry）、文件锁（file lock）
2. 提供了访问遗留代码库的能力，从而可以访问「遗留数据」
3. 可以通过本地语言，编写程序中「注重性能的部分」，以提高系统性能



用本地方法来访问特定于平台的机制是合法的，但很少有必要：随着 Java 平台逐渐成熟，其提供了很多在这以前只针对宿主平台的特性，比如进程 API，在 Java 9 中新增了，可访问操作系统的进程。当Java中没有等效的库时候，用本地方法来使用本地库也是合法的。

使用本地方法来提高性能的做法不值得提倡，早起发型版即 Java 1.3 之前，这样做旺旺很有必要，但 JVM 实现变得越来越快了，大部分任务，不用本地方法也能获得相似的性能。比如 1.3 之前的 `java.math.BigInteger` 是用 C 语言写的，但 1.3 发布时 `BigInteger` 用 Java 重写了，并进行了性能调优。



使用本地方法有一些严重的缺点。因为本地语言不是安全的，所以使用本地方法的程序不能免收内存毁坏错误的影响。因为本地语言是平台相关的，使用本地方法的应用程序也不再是可自由移植的。使用本地方法的应用程序也更难调试。在进入和退出本地代码时，需要相关的固定开销，所以，如果本地代码只是做少量的工作，本地方法就可能降低性能。最后一点，需要「胶合代码」的本地方法编写起来单调乏味并且难以阅读。



总而言之，在使用本地方法之前务必三思。极少数情况下会需要使用本地方法来提高性能。如果你必须要使用本地方法来访问底层的资源，或者遗留代码库，也要尽可能少用本地代码，并且要全面进行测试。本地代码中的一个Bug就有可能破坏整个应用程序。

